# 자동매매 봇 개발자 계획서 (Python + PostgreSQL)

Kent Beck 스타일(간결함, 피드백, 작은 단계, 지속적 리팩터링)을 기준으로 작성한 구현 가이드라인입니다.

---

## 1. 핵심 원칙

- **단순함(Simplicity):** 지금 필요한 것만 만든다. 미래 확장성은 구조로만 준비하고 기능은 나중에 추가한다.
- **피드백(Feedback):** 빠른 피드백 루프를 만들기 위해 테스트를 먼저 작성하고 작은 단위로 완성한다.
- **용기(Courage):** 설계를 과도하게 복잡하게 하지 않고 필요 시 리팩터링한다.
- **소통(Communication):** 시스템의 상태와 의도를 코드/로그/문서로 명확히 남긴다.

---

## 2. 기술 스택 및 기본 전제

- **언어:** Python 3.13
- **DB:** PostgreSQL
- **운영 환경:** Windows + 한국투자증권 오픈API(REST + WebSocket)
- **설계 방향:** 전략(의사결정)과 실행(주문) 분리, 상태 복구 가능한 구조

---

## 3. 프로젝트 구조 가이드

권장 구조(예시):

- `src/`
  - `stock_manager/`
    - `config/` (환경/설정 로딩)
    - `domain/` (순수 도메인: 전략/리스크/모델)
    - `service_layer/` (유스케이스: 장 시작/복구/주문 실행)
    - `adapters/` (외부 의존성 어댑터)
      - `broker/` (한국투자증권 REST/WS)
      - `storage/` (PostgreSQL)
      - `notifications/` (Slack 등 알림)
      - `observability/` (logger/metrics)
    - `entrypoints/` (CLI/worker/scheduler)
    - `utils/`
- `tests/`
- `ai_developer_guides/`

**원칙:**
- 외부 의존성(브로커, DB, API)을 **포트/어댑터 패턴**으로 분리
- 도메인 로직은 순수 파이썬 모듈에 유지

---

## 4. 데이터베이스 설계 가이드 (PostgreSQL)

### 4.1 핵심 테이블(최소 셋)

- `strategies` : 전략 메타 정보
- `strategy_params` : 날짜/버전별 파라미터
- `orders` : 주문 상태 (DB 단일 원본)
- `fills` : 체결 기록
- `positions` : 포지션 스냅샷
- `events` : 시스템 이벤트/오류 로그

상세 스키마/DDL은 `ai_developer_guides/DB_SCHEMA_DDL.md`를 단일 기준으로 따른다.

### 4.2 데이터 원칙

- DB는 **진실의 원천(Single Source of Truth)** 역할
- **주문 상태 전이 규칙**을 테이블 설계와 코드에서 일치시킨다
- 체결은 변경 불가 데이터로 저장(append only)

---

## 5. 상태 복구 및 동기화

- 재시작 시 `orders`, `fills`, `positions`를 기준으로 상태 복구
- 브로커 상태와 DB가 다를 경우, **브로커를 우선 기준**으로 하되 반드시 로그/이벤트 기록
- 복구 실패 시 거래 중지 모드로 진입

---

## 6. 전략 및 실행 분리

- 전략 모듈은 **순수 함수 스타일**로 구성
- 실행(유스케이스)은 **리스크 체크 + 주문 생성 + 주문 전송**을 조합
- 전략은 주문을 직접 호출하지 않고, **주문 신호만 생성**

---

## 7. 리스크 관리

- 일 손실 한도 / 종목별 최대 노출 / 총 포지션 수 제한을 우선 구현
- 리스크 로직은 `domain/`에 집중
- 리스크 위반 시 주문은 생성되더라도 **전송 전에 차단**

---

## 8. 트랜잭션 및 동시성

- 주문 상태 변경은 **항상 DB 트랜잭션**으로 처리
- 동시성 이슈 방지를 위해 **주문 생성-전송-저장** 순서를 고정
- 주문 중복 방지를 위해 **idempotency key** 사용

---

## 9. 에러 처리 및 복구

- 외부 API 실패 시 **재시도 + 지수 백오프** 적용
- 핵심 단계 실패 시 “거래 중지 모드”로 전환
- 예외는 반드시 `events` 테이블에 기록

---

## 10. 로깅 및 모니터링

- 로그는 `INFO` 이상 기본, 실패 시 `ERROR`
- 주문/체결/리스크 차단은 별도 이벤트 로그 기록
- 장 시작, 종료, 복구 이벤트는 반드시 남긴다

---

## 11. 테스트 전략 (Kent Beck 스타일)

- 작은 기능부터 테스트 작성 (TDD)
- 순수 함수(전략, 리스크)부터 테스트
- 브로커/DB는 인터페이스로 분리 후 통합 테스트 작성
- 테스트는 **빠르게 실행**되어야 함 (피드백 루프 확보)

---

## 12. 배포 및 운영

- `.env` 기반 설정 분리
- 운영 모드/모의 모드 분리
- 최소한의 자동화(서비스 시작/중지 스크립트) 제공

---

## 13. 단계별 개발 로드맵

1. **핵심 도메인 모델 정의** (orders, fills, positions)
2. **PostgreSQL 스키마 작성 + 마이그레이션 도입**
3. **상태 복구 로직 구현**
4. **리스크 관리 로직 구현**
5. **전략 인터페이스 + 예제 전략**
6. **브로커 어댑터 더미 구현 → 실계좌 연동**
7. **통합 테스트 + 운영 로그 정리**

---

## 14. 품질 기준

- 기능 추가 전 항상 테스트 작성
- 동작 중단 시 안전(거래 중지) 방향으로 설계
- 모든 핵심 흐름에 로그/이벤트 기록

---

## 15. 마무리

이 문서는 **작고 안전한 단위로 개발**하고, **빠른 피드백을 얻는 개발 루틴**을 목표로 한다.
처음부터 완벽한 설계보다 **작동하는 시스템**을 우선으로 만든다.
