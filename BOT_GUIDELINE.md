📘 한국투자증권 오픈API 자동매매 봇
장 시작 시 머신 동작 계획서
(구현 제외 / 설계·운영 계획 전용 문서)

────────────────────────────────
1. 목적 및 설계 원칙
────────────────────────────────

1.1 목적
- 장 시작 시 자동매매 머신이 안정적으로 기동
- DB에 저장된 전략 파라미터만을 사용하여 매매 수행
- 재시작/장애 상황에서도 동일한 상태로 복구 가능
- 중복 주문, 상태 불일치, 과도한 리스크 발생 방지

1.2 설계 원칙
- 전략(의사결정)과 실행(주문/체결) 완전 분리
- 모든 판단은 “상태 + 파라미터” 기반
- 장 시작 시 기준 상태를 고정하고 장중 변경 금지
- REST 호출 최소화, 실시간 이벤트 중심 구조
- 실패 시 항상 “거래 중지 쪽으로” 보수적 동작

────────────────────────────────
2. 장 시작 전제 조건
────────────────────────────────

2.1 환경 조건
- 한국투자증권 오픈API 사용 가능(REST + WebSocket)
- 앱키/시크릿 발급 및 인증 가능 상태
- 네트워크 연결 정상
- 자동매매 프로세스 단일 인스턴스 실행 보장

2.2 데이터 조건
- DB 접근 가능
- 전략 파라미터 테이블 존재
- 전일 주문/체결 기록 보존
- 계좌 정보 사전 등록 완료

────────────────────────────────
3. 장 시작 단계별 동작 계획
────────────────────────────────

3.1 프로세스 초기화

목적:
- 실행 환경 및 운영 모드 확정

동작:
- 현재 시간 확인 (거래일/개장 여부 판단)
- 설정 파일 로드
- 로그 시스템 초기화
- 알림 채널 연결
- 실계좌/모의투자 모드 확인

실패 시:
- 필수 설정 누락 시 즉시 종료 및 알림

────────────────────────────────

3.2 한국투자증권 오픈API 인증

목적:
- 거래 수행을 위한 유효 세션 확보

동작:
- REST 접근토큰(access_token) 발급
- WebSocket 접속키(approval_key) 발급
- 토큰/키 유효성 확인

실패 시:
- 지정 횟수 재시도
- 반복 실패 시 프로세스 종료 + 알림

────────────────────────────────

3.3 계좌 및 기본 정보 초기화

목적:
- 거래 가능 상태 판단
- 초기 리스크 기준 확보

동작:
- 계좌번호 조회
- 예수금 및 주문 가능 금액 조회
- 계좌 권한(실계좌/모의) 검증
- 잔고 조회

실패 시:
- 계좌 정보 불일치 시 거래 중지 모드 전환

────────────────────────────────

3.4 전략 파라미터 로드

목적:
- 오늘 사용할 전략 기준 확정

동작:
- DB에서 (오늘 날짜 + ACTIVE 상태) 파라미터 조회
- 파라미터 유효성 검증
  - 값 범위
  - 타입
  - 상호 제약 조건
- 파라미터 버전 고정 (장중 변경 금지)

예외 처리:
- ACTIVE 파라미터 없음
  - 정책 1: 전일 파라미터 사용
  - 정책 2: 거래 중지
  - 정책 3: 수동 승인 대기

────────────────────────────────

3.5 상태 복구 및 동기화 (핵심 단계)

목적:
- 재시작/비정상 종료에도 동일 상태 복원

동작:
- DB에서 미종결 주문 조회
- 한국투자증권 API에서 현재 주문 상태 조회
- DB 주문 상태와 브로커 상태 비교
- 상태 불일치 해결 및 동기화
- 현재 포지션 조회
- 체결 기록 기반 포지션 재계산

결과:
- 신뢰 가능한 현재 상태 스냅샷 생성
- 중복 주문 방지 기준 확정

실패 시:
- 상태 복구 불가 → 거래 중지 모드

────────────────────────────────

3.6 리스크 가드레일 초기화

목적:
- 장 시작 전 거래 가능 여부 판단

적용 기준:
- 일 손실 한도
- 종목별 최대 노출
- 총 포지션 수
- 연속 손실 횟수
- 변동성 급증 여부(선택)

결과:
- 거래 가능
- 관찰 모드 (신호 계산만)
- 거래 완전 중지

────────────────────────────────

3.7 관심 종목(Universe) 확정

목적:
- 장중 감시 대상 종목 확정

구성 방식:
- DB 저장 종목 리스트
- 전일 선정 결과
- 조건검색 결과(선택)

원칙:
- 장중 Universe 변경 최소화
- 변경 시 로그 및 사유 기록

────────────────────────────────

3.8 실시간 이벤트 등록

목적:
- 이벤트 기반 장중 운영 준비

등록 대상:
- 실시간 체결 데이터(WebSocket)
- 실시간 호가 데이터(필요 시, WebSocket)
- 주문/체결 상태 이벤트(WebSocket)

결과:
- 장중 메인 루프 진입 준비 완료

────────────────────────────────
4. 장중 동작 개요 (요약)
────────────────────────────────

- 실시간 이벤트 수신
- Market State 업데이트
- 전략 파라미터 기반 신호 계산
- 리스크 검증
- 주문 생성 및 전송
- 주문/체결 DB 기록
- 킬 스위치 조건 상시 감시

※ 장 시작 단계에서 기준 상태가 고정되므로
   장중 로직은 단순·안정적으로 유지됨

────────────────────────────────
5. 장 시작 실패 시 운영 정책
────────────────────────────────

- 로그인 실패: 재시도 후 종료
- 파라미터 미존재: 거래 중지
- 상태 복구 실패: 거래 중지
- 계좌 정보 불일치: 관찰 모드

────────────────────────────────
6. 핵심 요약
────────────────────────────────

- 장 시작은 “복구 + 고정” 단계
- 전략은 장중 변경되지 않음
- 엔진은 판단자가 아닌 상태 관리자
- 사고의 대부분은 장 시작 단계에서 예방 가능
