#!/usr/bin/env python3
"""
KIS OpenAPI Pre-commit Hook

Automatically validates and regenerates API documentation when Excel files change.

Triggered files:
- docs_raw/*.xlsx (Excel source files)
- docs_raw/categories.json (Category configuration)
- docs_raw/template.md (Documentation template)

Actions:
1. Run documentation validation
2. Regenerate documentation if validation passes
3. Fail commit if validation fails

Installation:
    cp scripts/hooks/pre-commit .git/hooks/pre-commit
    chmod +x .git/hooks/pre-commit
"""

import os
import subprocess
import sys
from pathlib import Path

# Project root
PROJECT_ROOT = Path(__file__).parent.parent.parent
VALIDATE_SCRIPT = PROJECT_ROOT / "scripts" / "validate_docs.py"
PARSE_SCRIPT = PROJECT_ROOT / "scripts" / "parse_kis_excel.py"


def run_command(cmd: list, description: str) -> bool:
    """Run a command and return success status."""
    print(f"\n{'=' * 60}")
    print(f"Running: {description}")
    print(f"Command: {' '.join(cmd)}")
    print(f"{'=' * 60}")

    result = subprocess.run(
        cmd,
        cwd=PROJECT_ROOT,
        capture_output=True,
        text=True
    )

    if result.stdout:
        print(result.stdout)

    if result.stderr:
        print(result.stderr, file=sys.stderr)

    if result.returncode != 0:
        print(f"❌ {description} - FAILED")
        return False
    else:
        print(f"✅ {description} - SUCCESS")
        return True


def check_excel_files_changed(staged_files: list) -> bool:
    """Check if any Excel files are staged for commit."""
    excel_extensions = ['.xlsx', '.xls']
    return any(
        any(f.suffix.lower() in excel_extensions for f in staged_files)
    )


def get_staged_files() -> list:
    """Get list of staged files."""
    result = subprocess.run(
        ['git', 'diff', '--cached', '--name-only', '--diff-filter=ACM'],
        cwd=PROJECT_ROOT,
        capture_output=True,
        text=True
    )

    if result.returncode != 0:
        return []

    files = []
    for line in result.stdout.strip().split('\n'):
        if line:
            file_path = PROJECT_ROOT / line
            if file_path.exists():
                files.append(file_path)

    return files


def main() -> int:
    """Main pre-commit hook function."""
    print("\n" + "=" * 60)
    print("KIS OpenAPI Pre-commit Hook")
    print("=" * 60)

    # Get staged files
    staged_files = get_staged_files()

    if not staged_files:
        print("No staged files found. Skipping pre-commit checks.")
        return 0

    print(f"\nStaged files: {len(staged_files)}")

    # Check if documentation-related files changed
    doc_related_files = [
        f for f in staged_files
        if 'docs_raw' in str(f) or f.suffix.lower() in ['.xlsx', '.xls', '.json']
    ]

    if not doc_related_files:
        print("\nNo documentation-related files changed. Skipping pre-commit checks.")
        return 0

    print(f"\nDocumentation-related files changed: {len(doc_related_files)}")
    for f in doc_related_files:
        print(f"  - {f}")

    # Check if Python is available
    if sys.version_info < (3, 8):
        print("\n⚠️  Warning: Python 3.8+ required for documentation generation")
        print("   Skipping automated documentation generation")
        return 0

    # Step 1: Validate existing documentation
    print("\n" + "=" * 60)
    print("Step 1: Validating existing documentation")
    print("=" * 60)

    if VALIDATE_SCRIPT.exists():
        if not run_command(
            [sys.executable, str(VALIDATE_SCRIPT)],
            "Documentation Validation"
        ):
            print("\n❌ Documentation validation failed")
            print("   Please fix the issues before committing")
            print("   Run: python scripts/validate_docs.py --fix")
            return 1
    else:
        print(f"⚠️  Validation script not found: {VALIDATE_SCRIPT}")
        print("   Skipping validation step")

    # Step 2: Regenerate documentation
    print("\n" + "=" * 60)
    print("Step 2: Regenerating API documentation")
    print("=" * 60)

    if PARSE_SCRIPT.exists():
        if not run_command(
            [sys.executable, str(PARSE_SCRIPT), '--all'],
            "Documentation Generation"
        ):
            print("\n❌ Documentation generation failed")
            print("   Please fix the errors before committing")
            return 1

        # Stage newly generated files
        print("\n" + "=" * 60)
        print("Staging generated documentation files")
        print("=" * 60)

        result = subprocess.run(
            ['git', 'add', 'docs/kis-openapi/api/', 'docs/kis-openapi/_data/tr_id_mapping.json'],
            cwd=PROJECT_ROOT
        )

        if result.returncode == 0:
            print("✅ Generated files staged successfully")
        else:
            print("⚠️  Warning: Failed to stage generated files")
            print("   You may need to manually stage them:")
            print("   git add docs/kis-openapi/api/")
            print("   git add docs/kis-openapi/_data/tr_id_mapping.json")
    else:
        print(f"⚠️  Parse script not found: {PARSE_SCRIPT}")
        print("   Skipping documentation generation")

    # Success
    print("\n" + "=" * 60)
    print("✅ Pre-commit checks passed")
    print("=" * 60 + "\n")

    return 0


if __name__ == "__main__":
    sys.exit(main())
